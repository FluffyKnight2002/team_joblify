<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Password Change</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/assets/vendors/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/pages/auth.css">
    <link rel="shortcut icon" href="/assets/images/favicon.svg" type="image/x-icon">
    <style>
        /* Custom CSS to hide background image of validation */
        .form-control.is-invalid, .was-validated .form-control:invalid {
          background-image: none !important;
        }
        .form-control.is-valid, .was-validated .form-control:valid {
          background-image: none !important;
        }
      </style>
</head>

<body>
<div id="auth">

    <div class="row h-100">
        <div class="d-flex justify-content-center align-items-center">
            <div class="py-4 px-3 px-md-4 px-lg-5 shadow-lg col-10 col-sm-8 col-md-8 col-lg-4 mx-auto" style="border-radius: 30px;">
                <h1 class="auth-title text-center pb-4">Password Change</h1>

                <div class="mt-md-2 text-center"><h3 class="success-line"></h3></div>

                <form id="password-change" method="post" class="needs-validation" novalidate>
                    <input type="hidden" id="id" name="id" th:value="${id}">
                    <div class="form-floating form-group position-relative has-icon-left mb-4">
                        <input type="password" class="form-control" placeholder="Old Password" id="oldPassword" name="oldPassword" required>
                        <label for="oldPassword">
                            <i class="bi bi-person"></i>
                            Old Password
                        </label>
                        <div class="invalid-feedback" id="oldPassword-error">
                            Please add Old Password.
                        </div>
                    </div>

                    <div class="form-floating form-group position-relative has-icon-left mb-4">
                        <input type="password" class="form-control" placeholder="New Password" id="newPassword" name="newPassword" required>
                        <label for="newPassword">
                            <i class="bi bi-shield-lock"></i>
                            New Password
                        </label>
                        <div class="invalid-feedback" id="newPassword-error">
                            Please add New Password.
                        </div>
                    </div>

                    <div class="form-floating form-group position-relative has-icon-left mb-4">
                        <input type="password" class="form-control" placeholder="Confirm Password" id="confirmPassword" name="confirmPassword" required>
                        <label for="confirmPassword">
                            <i class="bi bi-shield-lock"></i>
                            Confirm Password
                        </label>
                        <div class="invalid-feedback" id="confirmPassword-error">
                            Please add Confirm Password.
                        </div>
                    </div>


                    <div class="d-flex justify-content-center align-items-center">
                        <div class="d-grid gap-2 col-8">
                            <button type="submit" class="btn btn-primary rounded-pill mt-2">Change</button>
                        </div>
                    </div>
                </form>
                <div class="text-center mt-3 text-lg fs-6">
                    <p><a class="font-bold fs-6" th:href="@{/forgot-password-form(email=${#authentication.principal.getEmail})}">Forgot password?</a></p>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="/assets/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script>

    // Get the query string from the URL
    const queryString = window.location.search;

    // Parse the query string into an object
    const params = new URLSearchParams(queryString);

    // Get specific parameter values
    const email = params.get('email');

    console.log('email:', email);

    const oldPasswordError = document.getElementById('oldPassword-error');
    const confirmPasswordError = document.getElementById('confirmPassword-error');
    const newPasswordError = document.getElementById('newPassword-error');

    const mainForm = document.getElementById('password-change');
    (() => {
        'use strict';
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        const forms = document.querySelectorAll('.needs-validation');
        // Loop over them and prevent submission
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
                oldPasswordError.innerHTML='Please Add Old Password';
                newPasswordError.innerHTML='Please Add New Password'; 
                confirmPasswordError.innerHTML='Please Add Confirm Password';
                if(oldRealPassword === newPasswordInput.value){
                    newPasswordInput.classList.add('is-invalid')
                }
            }, false);
        });
    })();

// <----------------------Defaut Validation end here ------------------------->

    let oldRealPassword = '';

    const oldPasswordInput = document.getElementById('oldPassword');
    oldPasswordInput.addEventListener('input', oldPasswordCheck);

    

    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    

    const idInput = document.getElementById('id');
    const id = idInput.value;

    const metaCsrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    console.log(metaCsrfToken);

    let oldCheck;
    async function oldPasswordCheck() {
        const oldPassword = oldPasswordInput.value;
        console.log(oldPassword);

        
        oldCheck = await fetch('/old-password-check?oldPassword=' + encodeURIComponent(oldPassword) + '&email=' + encodeURIComponent(email), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'X-XSRF-Token': metaCsrfToken,
            }
        })
            .then(response => response.json())
            .then((data) => {
                if (data === true) {
                    oldPasswordInput.classList.add('is-valid');
                    oldPasswordInput.classList.remove('is-invalid');
                    oldPasswordError.classList.add('valid-feedback');
                    oldPasswordError.classList.remove('invalid-feedback');
                    oldPasswordError.innerHTML = 'Old Password is Correct.';
                    
                    oldRealPassword = oldPassword;
                    return true;
                } else {
                    oldPasswordInput.classList.add('is-invalid');
                    oldPasswordInput.classList.remove('is-valid');
                    oldPasswordError.classList.remove('valid-feedback');
                    oldPasswordError.classList.add('invalid-feedback');
                    oldPasswordError.innerHTML = 'Old Password is Wrong.';

                    mainForm.classList.remove('was-validated')
                    return false;
                }
            })
            .catch(error => {
                console.error("An error occurred during check Old Password:", error);
                // Handle any errors that occur during the fetch request
            });
    }

    function checkPasswordsMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        console.log(oldRealPassword);

        if (newPassword === '' && confirmPassword === '') {
            newPasswordInput.classList.remove('is-valid');
            newPasswordInput.classList.remove('is-invalid');

            confirmPasswordInput.classList.remove('is-valid');
            confirmPasswordInput.classList.remove('is-invalid');

            confirmPasswordError.classList.remove('invalid-feedback');
            confirmPasswordError.classList.remove('valid-feedback');

            newPasswordError.classList.remove('invalid-feedback');
            newPasswordError.classList.remove('valid-feedback');

            confirmPasswordError.innerHTML = '';
            newPasswordError.innerHTML = '';
            mainForm.classList.remove('was-validated')
            return false;

        } else if (newPassword === oldRealPassword) {
            if (newPassword === confirmPassword && newPassword !== '' && confirmPassword !== '') {
                newPasswordInput.classList.remove('is-valid');
                newPasswordInput.classList.add('is-invalid');

                newPasswordError.classList.remove('valid-feedback');
                newPasswordError.classList.add('invalid-feedback');

                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.remove('is-invalid');

                confirmPasswordError.classList.remove('valid-feedback');
                confirmPasswordError.classList.add('invalid-feedback');
                
                confirmPasswordError.innerHTML = '';
                newPasswordError.innerHTML = 'Passwords Match but New Password is Already Use.'

                return false;

            } else if (newPassword !== confirmPassword) {
                newPasswordInput.classList.remove('is-valid');
                newPasswordInput.classList.add('is-invalid');

                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');

                confirmPasswordError.classList.add('invalid-feedback');
                confirmPasswordError.classList.remove('valid-feedback');

                newPasswordError.classList.remove('invalid-feedback');
                newPasswordError.classList.add('valid-feedback');

                newPasswordError.innerHTML = '';
                confirmPasswordError.innerHTML = 'Passwords do not match and New Password is Already Use.';

                mainForm.classList.remove('was-validated');

                return false;

            }
        } else if (newPassword !== oldRealPassword) {
            if (newPassword === confirmPassword && newPassword !== '' && confirmPassword !== '') {
                newPasswordInput.classList.add('is-valid');
                newPasswordInput.classList.remove('is-invalid');

                newPasswordError.classList.remove('valid-feedback');
                newPasswordError.classList.add('invalid-feedback');

                confirmPasswordInput.classList.add('is-valid');
                confirmPasswordInput.classList.remove('is-invalid');

                confirmPasswordError.classList.add('valid-feedback');
                confirmPasswordError.classList.remove('invalid-feedback');

                newPasswordError.innerHTML = '';
                confirmPasswordError.innerHTML = 'Passwords Match.'
                mainForm.classList.remove('was-validated')
                return true;

            } else if (newPassword !== confirmPassword) {
                newPasswordInput.classList.remove('is-valid');
                newPasswordInput.classList.add('is-invalid');

                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');

                confirmPasswordError.classList.add('invalid-feedback');
                confirmPasswordError.classList.remove('valid-feedback');

                newPasswordError.classList.remove('invalid-feedback');
                newPasswordError.classList.add('valid-feedback');

                newPasswordError.innerHTML = '';
                confirmPasswordError.innerHTML = 'Passwords do not match.';
                mainForm.classList.remove('was-validated')
                return false;

            }
        }
    }
    confirmPasswordInput.addEventListener('input', checkPasswordsMatch);
    newPasswordInput.addEventListener('input', checkPasswordsMatch);
    function isFormValid() {
        const requiredFields = document.querySelectorAll('input[required]');

        for (const field of requiredFields) {
            if (!field.value.trim()) {
                return false;
            }
        }
        return true;
    }

    document.getElementById('password-change').addEventListener('submit', function (event) {
    event.preventDefault();

    console.log("Form submission event captured.");

    if (!isFormValid()) {
        console.log('Form data is not valid. Please fill all required fields.');
        return;
    }

    console.log("Form data is valid.");
  
    if (!checkPasswordsMatch() || oldCheck === false) {
        console.log('Form data is not valid. Password check failed.');
        if(oldRealPassword === newPasswordInput.value){
                    newPasswordInput.classList.add('is-invalid')
                    mainForm.classList.remove('was-validated');
                    
                    oldPasswordError.classList.add('invalid-feedback');
                    oldPasswordError.classList.remove('valid-feedback');
                    
                }
        return;
    }


    console.log("Password check successful.");

    const newPassword = newPasswordInput.value;
    const metaCsrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

    console.log(metaCsrfToken);

    fetch('/change-password?newPassword=' + encodeURIComponent(newPassword) + '&email=' + encodeURIComponent(email), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'X-XSRF-Token': metaCsrfToken
            },
            body: JSON.stringify({newPassword: newPassword, id: id})
        }
    )
        .then(response => {
            if (response.ok) {
                // Registration successful, handle the response
                console.log("Password Change successful");
                // You can redirect to another page or show a success message here

                window.location.href='/user-profile-edit?email=' + email;

            } else {
                // Registration failed, handle the error
                console.error("Password Change failed");
                // You can show an error message to the user here
                const successLine = document.querySelector('.success-line');
                successLine.innerHTML='Password Change Fail!';
                successLine.style.display = 'inline-block';
                successLine.style.color= 'red';
            }
        })
        .catch(error => {
            // An error occurred, handle the error
            console.error("An error occurred during Password Change:", error);
            // You can show an error message to the user here
        });
});




</script>
</body>

</html>